<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Iron Giants Mission Creation Tool</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --bg: #0f1116;
            --panel: #1a1c23;
            --border: #2b2e38;
            --text: #e6e9ef;
            --muted: #a0a3ad;
            --accent: #2688ff;
            --cell-border: #3a3f4b;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
            padding: 20px;
        }

        .panel {
            background-color: var(--panel);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.4);
            color: var(--text);
        }

        .tile-btn {
            padding: 6px 8px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: #22252f;
            cursor: pointer;
            font-size: 13px;
            color: var(--text);
            margin: 2px;
        }

        .tile-btn:hover {
            background: #2a2e3a;
        }

        .tile-btn.selected {
            outline: 2px solid var(--accent);
            background: #1b3c69;
        }

        .grid {
            display: inline-grid;
            background: #15171c;
            padding: 6px;
            border-radius: 8px;
        }

        .cell {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            user-select: none;
            border: 1px solid var(--cell-border);
            background: #fff;
            color: #000;
            transition: transform 0.05s;
        }

        .cell:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(255, 255, 255, 0.08)
        }

        .enemy-list {
            max-height: 160px;
            overflow: auto;
            border: 1px dashed var(--border);
            padding: 8px;
            border-radius: 6px;
        }

        pre {
            background: #0a0b0f;
            color: #d2d8e6;
            padding: 12px;
            border-radius: 8px;
            overflow: auto;
            font-size: 12px;
            border: 1px solid var(--border);
        }

        .small-btn {
            font-size: 12px;
            padding: 4px 8px;
        }

        label {
            font-size: 13px;
            color: var(--muted);
        }

        input.form-control,
        select.form-select,
        textarea.form-control {
            background-color: #22252f;
            color: var(--text);
            border: 1px solid var(--border);
        }

        input.form-control::placeholder,
        textarea.form-control::placeholder {
            color: var(--muted);
        }

        input.form-control:focus,
        select.form-select:focus,
        textarea.form-control:focus {
            background-color: #2a2e3a;
            color: var(--text);
            border-color: var(--accent);
            box-shadow: 0 0 0 0.2rem rgba(38, 136, 255, 0.25);
        }
    </style>
</head>

<body>
<h1 class="mb-4">Iron Giants Mission Creation Tool v0.0.9</h1>
<div class="row g-3">
    <div class="col-md-5">
        <div class="panel">
            <div class="mb-3">
                <label class="form-label">Mission Key</label>
                <input id="missionKey" type="text" class="form-control form-control-sm" placeholder="mission_2A"
                       value="mission_2A"/>
            </div>
            <div class="mb-3">
                <label class="form-label">Mission Name</label>
                <input id="missionName" type="text" class="form-control form-control-sm" placeholder="Secret Base"
                       value="Secret Base"/>
            </div>
            <div class="row g-2 mb-3">
                <div class="col-6">
                    <label class="form-label">Energy Cost</label>
                    <input id="energyCost" type="number" class="form-control form-control-sm" min="0" value="2"/>
                </div>
                <div class="col-6">
                    <label class="form-label">Mission Element</label>
                    <select id="element" class="form-select form-select-sm">
                        <option value="Physical">Physical</option>
                        <option value="Electric">Electric</option>
                        <option value="Explosive">Explosive</option>
                    </select>
                </div>
            </div>
            <div class="row g-2 mb-3">
                <div class="col-6">
                    <label class="form-label">Mission Biome</label>
                    <select id="biome" class="form-select form-select-sm">
                        <option value="Forest">Forest</option>
                        <option value="Tundra">Tundra</option>
                        <option value="Desert">Desert</option>
                        <option value="Volcanic">Volcanic</option>
                        <option value="Swamp">Swamp</option>
                    </select>
                </div>
            </div>

            <label class="form-label">Rewards</label>
            <div id="rewardsInputs" class="mb-3">
                <h6>First Time Clear</h6>
                <div class="row g-2 mb-2">
                    <div class="col">
                        <label class="form-label">Crate ID</label>
                        <input type="number" id="ftcCrateId" class="form-control form-control-sm" value="2"
                               placeholder="Crate ID"/>
                    </div>
                    <div class="col">
                        <label class="form-label">Crate Chance %</label>
                        <input type="number" id="ftcCrateChance" class="form-control form-control-sm" value="100"
                               placeholder="Crate Chance %"/>
                    </div>
                </div>
                <div class="row g-2 mb-2">
                    <div class="col">
                        <label class="form-label">Aetherium</label>
                        <input type="number" id="ftcAetherium" class="form-control form-control-sm" value="2"
                               placeholder="Aetherium"/>
                    </div>
                    <div class="col">
                        <label class="form-label">Crytite Min</label>
                        <input type="number" id="ftcCrytiteMin" class="form-control form-control-sm" value="1750"
                               placeholder="Crytite Min"/>
                    </div>
                    <div class="col">
                        <label class="form-label">Crytite Max</label>
                        <input type="number" id="ftcCrytiteMax" class="form-control form-control-sm" value="2250"
                               placeholder="Crytite Max"/>
                    </div>
                    <div class="col">
                        <label class="form-label">VoidStone Min</label>
                        <input type="number" id="ftcVoidMin" class="form-control form-control-sm" value="0"
                               placeholder="VoidStone Min"/>
                    </div>
                    <div class="col">
                        <label class="form-label">VoidStone Max</label>
                        <input type="number" id="ftcVoidMax" class="form-control form-control-sm" value="0"
                               placeholder="VoidStone Max"/>
                    </div>
                </div>

                <h6>Normal Clear</h6>
                <div class="row g-2 mb-2">
                    <div class="col">
                        <label class="form-label">Crate ID</label>
                        <input type="number" id="ncCrateId" class="form-control form-control-sm" value="2"
                               placeholder="Crate ID"/>
                    </div>
                    <div class="col">
                        <label class="form-label">Crate Chance %</label>
                        <input type="number" id="ncCrateChance" class="form-control form-control-sm" value="25"
                               placeholder="Crate Chance %"/>
                    </div>
                </div>
                <div class="row g-2 mb-2">
                    <div class="col">
                        <label class="form-label">Aetherium</label>
                        <input type="number" id="ncAetherium" class="form-control form-control-sm" value="0"
                               placeholder="Aetherium"/>
                    </div>
                    <div class="col">
                        <label class="form-label">Crytite Min</label>
                        <input type="number" id="ncCrytiteMin" class="form-control form-control-sm" value="1250"
                               placeholder="Crytite Min"/>
                    </div>
                    <div class="col">
                        <label class="form-label">Crytite Max</label>
                        <input type="number" id="ncCrytiteMax" class="form-control form-control-sm" value="1750"
                               placeholder="Crytite Max"/>
                    </div>
                    <div class="col">
                        <label class="form-label">VoidStone Min</label>
                        <input type="number" id="ncVoidMin" class="form-control form-control-sm" value="0"
                               placeholder="VoidStone Min"/>
                    </div>
                    <div class="col">
                        <label class="form-label">VoidStone Max</label>
                        <input type="number" id="ncVoidMax" class="form-control form-control-sm" value="0"
                               placeholder="VoidStone Max"/>
                    </div>
                </div>

                <div class="row g-2 mb-2 mt-2">
                    <div class="col">
                        <h6>Experience</h6>
                        <input type="number" id="experience" class="form-control form-control-sm" value="0"
                               placeholder="Experience"/>
                    </div>
                </div>
            </div>

            <div class="mb-3">
                <h6>Location</h6>
                <div class="row g-2 mb-2">
                    <div class="col">
                        <label class="form-label">X</label>
                        <input type="number" id="locX" class="form-control form-control-sm" value="0" />
                    </div>
                    <div class="col">
                        <label class="form-label">Y</label>
                        <input type="number" id="locY" class="form-control form-control-sm" value="0" />
                    </div>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label">Grid size</label>
                <div class="d-flex gap-2 mb-2">
                    <input id="gridW" type="number" min="1" value="5" class="form-control form-control-sm"
                           style="width:70px"/>
                    <input id="gridH" type="number" min="1" value="5" class="form-control form-control-sm"
                           style="width:70px"/>
                    <button id="makeGrid" class="btn btn-secondary btn-sm small-btn">Create Grid</button>
                    <button id="clearGrid" class="btn btn-secondary btn-sm small-btn">Clear</button>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label">Tile palette</label>
                <div class="palette mb-1" id="palette"></div>
                <div id="tileDescription" class="mt-2 text small"></div>
            </div>

            <div class="mb-3">
                <label class="form-label">Enemies</label>
                <div class="enemy-list" id="enemyList"></div>
            </div>

            <div class="d-flex gap-2">
                <button id="exportJSON" class="btn btn-primary btn-sm">Generate JSON</button>
                <button id="downloadJSON" class="btn btn-secondary btn-sm">Download JSON</button>
                <input id="loadFile" type="file" accept="application/json" class="form-control form-control-sm"/>
            </div>
        </div>
    </div>

    <div class="col-md-7">
        <div class="panel">
            <label class="form-label">Mission</label>
            <div id="gridContainer" class="mb-3 mt-1"></div>

            <label class="form-label">Generated JSON</label>
            <pre id="jsonOutput">Press "Generate JSON"</pre>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    (() => {
        const TILE_IDS = [
            "empty", "enemy", "reactor", "turbine", "wall", "player",
            "repairStation", "upgradeStation", "gateClosed", "gateOpen",
            "gateTerminal", "landmine", "beacon", "beaconTerminal"
        ];
        const TILE_LABELS = Object.fromEntries(TILE_IDS.map(t => [t, t]));
        const TILE_DESCRIPTIONS = {
            empty: "An empty space.",
            enemy: "Places an enemy at this location.",
            reactor: "Secondary objective structure",
            turbine: "Secondary objective.",
            wall: "A solid barrier that blocks movement",
            player: "Starting position of the player mech.",
            repairStation: "Heals the player when interacted with, has 2 charges",
            upgradeStation: "Allows the player to upgrade either their heat or energy.",
            gateClosed: "A closed gate blocking passage. (Opens when a gateTerminal is accessed)",
            gateOpen: "An open gate that allows passage. (Closes when a gateTerminal is accessed)",
            gateTerminal: "A console that can open/close gates.",
            landmine: "Explodes when a unit steps on it.",
            beacon: "Makes all the enemies in the mission stronger, can be disabled using a beaconTerminal",
            beaconTerminal: "Disables a beacon"
        };

        let grid = [], gridW = 5, gridH = 5;
        let selectedTile = "empty", enemyCount = 0, repairStationCount = 0, upgradeStationCount = 0;
        const enemies = {};

        const paletteEl = document.getElementById("palette"),
            gridContainer = document.getElementById("gridContainer"),
            enemyListEl = document.getElementById("enemyList"),
            missionKeyEl = document.getElementById("missionKey"),
            missionNameEl = document.getElementById("missionName"),
            energyCostEl = document.getElementById("energyCost"),
            elementEl = document.getElementById("element"),
            jsonOutput = document.getElementById("jsonOutput"),
            gridWEl = document.getElementById("gridW"),
            gridHEl = document.getElementById("gridH"),
            makeGridBtn = document.getElementById("makeGrid"),
            clearGridBtn = document.getElementById("clearGrid"),
            exportBtn = document.getElementById("exportJSON"),
            downloadBtn = document.getElementById("downloadJSON"),
            loadFileInput = document.getElementById("loadFile");

        function createPalette() {
            paletteEl.innerHTML = "";
            TILE_IDS.forEach(id => {
                const b = document.createElement("button");
                b.className = "tile-btn btn btn-sm";
                b.textContent = TILE_LABELS[id];

                b.addEventListener("click", () => {
                    selectedTile = id;
                    document.querySelectorAll(".tile-btn").forEach(x => x.classList.remove("selected"));
                    b.classList.add("selected");
                    document.getElementById("tileDescription").textContent = TILE_DESCRIPTIONS[id];
                });

                if (id === selectedTile) {
                    b.classList.add("selected");
                    document.getElementById("tileDescription").textContent = TILE_DESCRIPTIONS[id];
                }

                paletteEl.appendChild(b);
            });
        }

        function makeGrid(w, h) {
            gridW = w;
            gridH = h;
            grid = Array.from({length: h}, () => Array(w).fill("empty"));
            enemyCount = 0;
            for (const k in enemies) delete enemies[k];
            renderGrid();
            renderEnemyList();
        }

        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(el => new bootstrap.Tooltip(el));

        function renderGrid() {
            gridContainer.innerHTML = "";
            const g = document.createElement("div");
            g.className = "grid";
            g.style.gridTemplateColumns = `repeat(${gridW},40px)`;
            g.style.gridGap = "6px";
            for (let y = 0; y < gridH; y++) {
                for (let x = 0; x < gridW; x++) {
                    const c = document.createElement("div");
                    c.className = "cell";
                    c.dataset.x = x;
                    c.dataset.y = y;
                    updateCell(c, grid[y][x]);
                    c.addEventListener("click", () => onClick(x, y, c));
                    c.addEventListener("contextmenu", ev => {
                        ev.preventDefault();
                        const cur = grid[y][x];
                        if (cur.startsWith("enemy")) {
                            removeEnemy(cur);
                        } else if (cur.startsWith("repairStation")) {
                            repairStationCount = Math.max(0, repairStationCount - 1);
                            setCell(x, y, "empty");
                        } else if (cur.startsWith("upgradeStation")) {
                            upgradeStationCount = Math.max(0, upgradeStationCount - 1);
                            setCell(x, y, "empty");
                        } else {
                            setCell(x, y, "empty");
                        }
                    });
                    g.appendChild(c);
                }
            }
            gridContainer.appendChild(g);
        }

        function updateCell(c, v) {
            c.textContent = "";
            c.title = v;
            if (v === "empty") {
                c.textContent = "";
            } else if (v.startsWith("enemy")) {
                c.textContent = v;
                c.style.color = "#c33";
            } else {
                c.textContent = v;
                c.style.color = "#000";
            }
        }

        function onClick(x, y) {
            if (selectedTile === "enemy") {
                enemyCount++;
                const key = `enemy${enemyCount}`;
                setCell(x, y, key);
                const id = (Object.values(enemies).length ? Math.min(...Object.values(enemies).map(e => e.id)) - 1 : -1);
                enemies[key] = {id: id, type: "normal"};
                renderEnemyList();
                return;
            }

            if (selectedTile === "player") {
                for (let yy = 0; yy < gridH; yy++) {
                    for (let xx = 0; xx < gridW; xx++) {
                        if (grid[yy][xx] === "player") {
                            setCell(xx, yy, "empty");
                        }
                    }
                }
            }

            if (selectedTile === "beacon") {
                for (let yy = 0; yy < gridH; yy++) {
                    for (let xx = 0; xx < gridW; xx++) {
                        if (grid[yy][xx] === "beacon") {
                            setCell(xx, yy, "empty");
                        }
                    }
                }
            }

            const cur = grid[y][x];
            if (cur.startsWith("enemy")) removeEnemy(cur);

            if (selectedTile === "upgradeStation") {
                upgradeStationCount++;
                const key = `upgradeStation${upgradeStationCount}`;
                setCell(x, y, key);
            } else if (selectedTile === "repairStation") {
                repairStationCount++;
                const key = `repairStation${repairStationCount}`;
                setCell(x, y, key);
            } else {
                setCell(x, y, selectedTile);
            }
        }

        function setCell(x, y, v) {
            grid[y][x] = v;
            const c = gridContainer.querySelector(`.cell[data-x="${x}"][data-y="${y}"]`);
            if (c) updateCell(c, v);
        }

        function removeEnemy(k) {
            if (!enemies[k]) return;

            delete enemies[k];

            for (let y = 0; y < gridH; y++) {
                for (let x = 0; x < gridW; x++) {
                    if (grid[y][x] === k) {
                        grid[y][x] = "empty";
                        const c = gridContainer.querySelector(`.cell[data-x="${x}"][data-y="${y}"]`);
                        if (c) updateCell(c, "empty");
                    }
                }
            }

            enemyCount = Object.keys(enemies).length;

            renderEnemyList();
        }

        function renderEnemyList() {
            enemyListEl.innerHTML = "";
            const keys = Object.keys(enemies);
            if (!keys.length) {
                enemyListEl.textContent = "No enemies.";
                return;
            }
            keys.forEach(k => {
                const r = document.createElement("div");
                r.className = "d-flex gap-2 mb-1 align-items-center";

                const lbl = document.createElement("div");
                lbl.style.width = "70px";
                lbl.textContent = k;

                const id = document.createElement("input");
                id.type = "number";
                id.value = enemies[k].id;
                id.style.width = "80px";
                id.className = "form-control form-control-sm";
                id.addEventListener("change", () => enemies[k].id = parseInt(id.value));

                const type = document.createElement("select");
                type.className = "form-select form-select-sm";
                type.style.width = "100px";

                ["normal", "boss"].forEach(opt => {
                    const o = document.createElement("option");
                    o.value = opt;
                    o.textContent = opt;
                    if (enemies[k].type === opt) o.selected = true;
                    type.appendChild(o);
                });

                type.addEventListener("change", () => enemies[k].type = type.value);

                const element = document.createElement("select");
                element.className = "form-select form-select-sm";
                element.style.width = "100px";
                ["Physical", "Electric", "Explosive"].forEach(opt => {
                    const o = document.createElement("option");
                    o.value = opt;
                    o.textContent = opt;
                    if (enemies[k].element === opt) o.selected = true;
                    element.appendChild(o);
                });
                element.addEventListener("change", () => enemies[k].element = element.value);

                const rm = document.createElement("button");
                rm.textContent = "X";
                rm.className = "btn btn-sm btn-danger small-btn";
                rm.addEventListener("click", () => {
                    removeEnemy(k);
                    renderGrid();
                    renderEnemyList();
                });

                r.append(lbl, id, type, element, rm);
                enemyListEl.appendChild(r);

                if (!enemies[k].element) enemies[k].element = "Physical";
            });
        }

        function exportJSON() {
            const outGrid = grid.map(row => row.map(cell => String(cell || "empty")));

            const enemiesOut = {};
            for (const [k, v] of Object.entries(enemies))
                enemiesOut[k] = {id: v.id, type: v.type, element: v.element};

            const rewards = {
                firstTimeClear: {
                    crate: {
                        id: Number(document.getElementById("ftcCrateId").value),
                        chance: Number(document.getElementById("ftcCrateChance").value)
                    },
                    Aetherium: Number(document.getElementById("ftcAetherium").value),
                    Crytite: {
                        min: Number(document.getElementById("ftcCrytiteMin").value),
                        max: Number(document.getElementById("ftcCrytiteMax").value)
                    },
                    VoidStone: {
                        min: Number(document.getElementById("ftcVoidMin").value),
                        max: Number(document.getElementById("ftcVoidMax").value)
                    }
                },
                normalClear: {
                    crate: {
                        id: Number(document.getElementById("ncCrateId").value),
                        chance: Number(document.getElementById("ncCrateChance").value)
                    },
                    Aetherium: Number(document.getElementById("ncAetherium").value),
                    Crytite: {
                        min: Number(document.getElementById("ncCrytiteMin").value),
                        max: Number(document.getElementById("ncCrytiteMax").value)
                    },
                    VoidStone: {
                        min: Number(document.getElementById("ncVoidMin").value),
                        max: Number(document.getElementById("ncVoidMax").value)
                    }
                },
                "experience": Number(document.getElementById("experience").value),
            };

            const location = {
                X: Number(document.getElementById("locX").value),
                Y: Number(document.getElementById("locY").value)
            };

            const mission = {
                version: "0.0.9",
                key: missionKeyEl.value || "mission_1",
                name: missionNameEl.value || "",
                energyCost: Number(energyCostEl.value) || 0,
                element: elementEl.value || "",
                biome: document.getElementById("biome").value || "",
                gridWidth: gridW,
                gridHeight: gridH,
                grid: outGrid,
                enemies: enemiesOut,
                rewards,
                location: location
            };

            // Format rewards manually to keep them compact
            function formatRewards(r) {
                return `{
      "firstTimeClear": {
        "crate": { "id": ${r.firstTimeClear.crate.id}, "chance": ${r.firstTimeClear.crate.chance} },
        "Aetherium": ${r.firstTimeClear.Aetherium},
        "Crytite": { "min": ${r.firstTimeClear.Crytite.min}, "max": ${r.firstTimeClear.Crytite.max} },
        "VoidStone": { "min": ${r.firstTimeClear.VoidStone.min}, "max": ${r.firstTimeClear.VoidStone.max} }
      },
      "normalClear": {
        "crate": { "id": ${r.normalClear.crate.id}, "chance": ${r.normalClear.crate.chance} },
        "Aetherium": ${r.normalClear.Aetherium},
        "Crytite": { "min": ${r.normalClear.Crytite.min}, "max": ${r.normalClear.Crytite.max} },
        "VoidStone": { "min": ${r.normalClear.VoidStone.min}, "max": ${r.normalClear.VoidStone.max} }
      },
      "experience": ${r.experience}
    }`;
            }

            const json = JSON.stringify(mission, (key, value) => {
                if (key === "grid") return "__GRID__";
                if (key === "rewards") return "__REWARDS__";
                return value;
            }, 2)
                .replace(`"__GRID__"`, `[\n${outGrid.map(r => "    " + JSON.stringify(r)).join(",\n")}\n  ]`)
                .replace(`"__REWARDS__"`, formatRewards(rewards));

            jsonOutput.textContent = json;
            return mission;
        }

        function download() {
            const m = exportJSON();
            const blob = new Blob([jsonOutput.textContent], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = (m.key || "mission") + ".json";
            a.click();
            URL.revokeObjectURL(url);
        }

        makeGridBtn.onclick = () => makeGrid(+gridWEl.value || 5, +gridHEl.value || 5);
        clearGridBtn.onclick = () => {
            for (let y = 0; y < gridH; y++)
                for (let x = 0; x < gridW; x++)
                    grid[y][x] = "empty";
            for (const k in enemies) delete enemies[k];
            enemyCount = 0;
            repairStationCount = 0;
            upgradeStationCount = 0;
            renderGrid();
            renderEnemyList();
        };
        exportBtn.onclick = exportJSON;
        downloadBtn.onclick = download;

        function loadMissionFromJSON(data) {
            if (!data) return;
            missionKeyEl.value = data.key || "";
            missionNameEl.value = data.name || "";
            energyCostEl.value = data.energyCost || 0;
            elementEl.value = data.element || "Physical";

            if (data.location) {
                document.getElementById("locX").value = data.location.X ?? 0;
                document.getElementById("locY").value = data.location.Y ?? 0;
            }

            const r = data.rewards;
            if (r) {
                const ftc = r.firstTimeClear, nc = r.normalClear;
                document.getElementById("ftcCrateId").value = ftc.crate.id;
                document.getElementById("ftcCrateChance").value = ftc.crate.chance;
                document.getElementById("ftcAetherium").value = ftc.Aetherium;
                document.getElementById("ftcCrytiteMin").value = ftc.Crytite.min;
                document.getElementById("ftcCrytiteMax").value = ftc.Crytite.max;
                document.getElementById("ftcVoidMin").value = ftc.VoidStone.min;
                document.getElementById("ftcVoidMax").value = ftc.VoidStone.max;

                document.getElementById("ncCrateId").value = nc.crate.id;
                document.getElementById("ncCrateChance").value = nc.crate.chance;
                document.getElementById("ncAetherium").value = nc.Aetherium;
                document.getElementById("ncCrytiteMin").value = nc.Crytite.min;
                document.getElementById("ncCrytiteMax").value = nc.Crytite.max;
                document.getElementById("ncVoidMin").value = nc.VoidStone.min;
                document.getElementById("ncVoidMax").value = nc.VoidStone.max;

                document.getElementById("experience").value = r.experience;
                
                document.getElementById("biome").value = data.biome || "Forest";
            }

            gridW = data.gridWidth || 5;
            gridH = data.gridHeight || 5;
            gridWEl.value = gridW;
            gridHEl.value = gridH;
            grid = data.grid ? data.grid.map(row => [...row]) : [];
            renderGrid();

            for (const k in enemies) delete enemies[k];
            enemyCount = 0;
            if (data.enemies) {
                for (const [k, v] of Object.entries(data.enemies)) {
                    enemies[k] = {id: v.id, type: v.type};
                    enemyCount = Math.max(enemyCount, parseInt(k.replace(/\D/g, "")) || 0);
                }
            }
            renderEnemyList();

            for (let y = 0; y < gridH; y++) {
                for (let x = 0; x < gridW; x++) {
                    const c = gridContainer.querySelector(`.cell[data-x="${x}"][data-y="${y}"]`);
                    if (c) updateCell(c, grid[y][x]);
                }
            }

            jsonOutput.textContent = JSON.stringify(data, null, 2);
        }

        loadFileInput.addEventListener("change", e => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = evt => {
                try {
                    const data = JSON.parse(evt.target.result);
                    loadMissionFromJSON(data);
                } catch (err) {
                    alert("Invalid JSON file.");
                }
            };
            reader.readAsText(file);
            e.target.value = "";
        });

        makeGridBtn.onclick = () => makeGrid(+gridWEl.value || 5, +gridHEl.value || 5);
        clearGridBtn.onclick = () => {
            for (let y = 0; y < gridH; y++)
                for (let x = 0; x < gridW; x++)
                    grid[y][x] = "empty";
            for (const k in enemies) delete enemies[k];
            enemyCount = 0;
            renderGrid();
            renderEnemyList();
        };
        exportBtn.onclick = exportJSON;
        downloadBtn.onclick = download;

        createPalette();
        makeGrid(5, 5);
    })();
</script>
</body>

</html>
